<!doctype html>
<html>
	<head>

		<meta name="viewport" content="width=device-width, initial-scale=1">

		<style>

			html {
				font-size:20px;
			}
			body {
				line-height:1.5rem;
			}
			u {
				text-decoration: none;
				border-bottom: dotted 1px black;
			}

		</style>

	</head>
	<body>

		<!--<button id="btnStart">Start</button>-->


		<div id="place">
      
	    </div>
	    
	    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>


		<script>

			var NAME = 'Martin';

			if ('speechSynthesis' in window) {
				//$('#place').append('<div>speechSynthesis in window</div>');
				//$('#place').append('<div>number voices: ' + window.speechSynthesis.getVoices().length + '</div>');

				var msg = new SpeechSynthesisUtterance();

				var count = 0;

				msg.indx = count;

				var hasBoundary = false,
					wordIndex = 0,
					$currentContainer = $('<div/>'),
					lastCharIndex = 0;


				$(window).unload(function() {
					speechSynthesis.cancel();
				})

				window.speechSynthesis.onvoiceschanged=function() {
					onLoaded()
					speechSynthesis.onvoiceschanged=undefined;
				};
				var voices = window.speechSynthesis.getVoices();

				voices.length && onLoaded();
				$('#btnStart').on('click', onLoaded);


			}
			else {
				$('#place').append('Not speech');
			}

			function createContainer(indx) {
				var $el = $('<div/>').attr('id', 'cont' + indx);
				$('#place').append($el);
				return $el;
			}

			function onLoaded() {

			  //$('#place').append('<div>loaded voices: ' + window.speechSynthesis.getVoices().length + '</div>');
			 
			  var voices = window.speechSynthesis.getVoices();
			  var words='ayicukuka xivam o usoha o edavu oxexig epip wucozixe unecit exi ikaxis iqocadohu fu pakaqimut pe oqamo ipe jesigire bapal fuveyudafa adocoqiboc tuloragi'.split(' ');


			  $('#place').append(createContainer(count));

			  speak();

			  

			  function getSentance() {
			    var count = _.random(3,10);
			    var selected = [];

			    for(var i=0;i<count;i++) {
					var word = words[_.random(0,words.length-1)];
					word = word.replace(' ', '');
					selected.push(word);
			    }

			    selected.push(NAME);
			    selected = _.shuffle(selected);

			    try {
			    	selected[0]=selected[0].substr(0,1).toUpperCase() + selected[0].substr(1);
			    }
			    catch(e) {
			      //swallow
			    }
			    return selected.join(' ') + '.';
			  }

			  function speak() {

			    count++;


			    $('#place').append(createContainer(count));

			    // get random voice
			    var index = Math.floor(Math.random() * voices.length); 
			    
			    msg.voice = voices[index]; 
			    msg.lang = voices[index].lang; 
			    msg.text = count + ', ' + getSentance();
			    msg.rate= /iPad|iPhone|iPod/.test(navigator.userAgent) ? 0.2 : 0.8;

			    lastCharIndex=0;
			    speechSynthesis.speak(msg);

			    
			  }


			  msg.onstart = function() {
			    console.log('onStart');
			    this.hasBoundary = false;
			    wordIndex = 0;
			  }
			  
			  msg.onboundary = function(e) {

			    this.hasBoundary = true;

			    if(lastCharIndex>e.charIndex) {
			    	//lastCharIndex = endIndex;
			    	return;
			    }

			    console.log(lastCharIndex);
			    var endIndex = msg.text.indexOf(' ', lastCharIndex);
			    //console.log(endIndex);

			    var word = msg.text.substring(0, endIndex);

			    if(!word.length && lastCharIndex>0) {
			    	word = msg.text;
			    }

			    word = word.replace(NAME, '<u>' + NAME + '</u>');

			    //console.log('word', word, endIndex);

			    var $el = $('#cont' + count);

			    $el.html(word);
			    lastCharIndex = endIndex+1;

			    //return;

			    /*
			    var word = e.utterance.text.substr(lastCharIndex, endIndex-lastCharIndex);
			    
			    lastCharIndex = endIndex;

			    if(word=='Martin') {
			      word ='<u>Martin</u>';
			    }
			    console.log('onBoundary', e.charIndex ,word);
			    //word && $currentContainer.html($currentContainer.html() + ' ' + word);
			    wordIndex++;
			    */
			  }

			  msg.onend = function(e) {

			    console.log('onEnd', hasBoundary);
			    if(!this.hasBoundary) {
			    	//$currentContainer.html(msg.text);
			    	//$('#cont' + this.indx).html(msg.text);
			    }
			    //$currentContainer  = $('<div>1.</div>');
			    //$('#place').append($currentContainer );
				setTimeout(function() {
			    	speak();
			    }, 750);
			  }


			  
			}

		</script>
	</body>
</html>